"""
خدمة محاكاة الذكاء الاصطناعي المحلية
=================================
وحدة برمجية توفر ردودًا محلية على الأسئلة المتعلقة بالكيمياء الحيوية
عندما يكون هناك مشكلة في الاتصال بمزودي الذكاء الاصطناعي على الإنترنت.

يتم استخدام هذا النظام كحل احتياطي لضمان استمرارية عمل المساعد الذكي
حتى في ظروف الاتصال السيئة أو عدم توفر الإنترنت.
"""

import re
import random
import json
import os
from datetime import datetime
import pathlib

# المسار إلى ملف قاعدة المعرفة المحلية
current_dir = pathlib.Path(__file__).parent.absolute()
KNOWLEDGE_DB_PATH = os.path.join(current_dir, 'local_knowledge.json')

# مجموعة من الإجابات العامة للاستخدام عندما لا توجد إجابة محددة
GENERAL_RESPONSES = [
    "هذا سؤال مثير للاهتمام حول الكيمياء الحيوية. بناءً على معرفتي المحلية، ",
    "وفقاً للمعلومات المتاحة لدي عن الكيمياء الحيوية، ",
    "من منظور علم الكيمياء الحيوية، يمكنني أن أقول إن ",
    "سؤالك عن الكيمياء الحيوية مهم، وأستطيع أن أخبرك أن "
]

# الأنماط العامة للأسئلة الشائعة مع الكلمات المفتاحية
COMMON_PATTERNS = {
    r'\b(ما|ماذا|ما هو|ما هي)\b.*(إنزيم|انزيم|الإنزيم|الانزيم)': 'enzyme',
    r'\b(ما|ماذا|ما هو|ما هي)\b.*(بروتين|البروتين)': 'protein',
    r'\b(ما|ماذا|ما هو|ما هي)\b.*(dna|الدنا|الحمض النووي)': 'dna',
    r'\b(ما|ماذا|ما هو|ما هي)\b.*(rna|الرنا)': 'rna',
    r'.*\b(دورة كريبس|كريبس)\b.*': 'krebs',
    r'.*\b(ببتيد|الببتيد|الرابطة الببتيدية|رابطة ببتيدية)\b.*': 'peptide',
    r'.*\b(التمثيل الغذائي|الأيض)\b.*': 'metabolism',
    r'.*\b(البروتين السكري|بروتين سكري)\b.*': 'glycoprotein',
    r'.*\b(التنفس الخلوي|تنفس خلوي)\b.*': 'cellular_respiration',
    r'.*\b(البناء الضوئي|بناء ضوئي)\b.*': 'photosynthesis',
    r'.*\b(أحماض أمينية|الأحماض الأمينية|حمض أميني)\b.*': 'amino_acid'
}

# قاموس الإجابات الأساسية
BASE_RESPONSES = {
    'enzyme': 'الإنزيمات هي جزيئات بروتينية تعمل كمحفزات حيوية تسرع التفاعلات الكيميائية في الخلايا الحية دون أن تستهلك في التفاعل. يمكن للإنزيمات أن تزيد سرعة التفاعلات بمعدل يصل إلى 10¹⁷ مرة. كل إنزيم له موقع نشط محدد يرتبط بالركيزة (المادة المتفاعلة) ويحفز تحويلها إلى منتج.',
    'protein': 'البروتينات هي جزيئات كبيرة مكونة من سلاسل من الأحماض الأمينية. تقوم بوظائف متعددة في الجسم مثل الإنزيمات للتحفيز، النقل مثل الهيموغلوبين، الدعم الهيكلي مثل الكولاجين، والحماية المناعية مثل الأجسام المضادة.',
    'dna': 'الحمض النووي الريبوزي منقوص الأكسجين (DNA) هو جزيء يحمل المعلومات الوراثية لجميع الكائنات الحية. يتكون من سلسلتين ملتفتين حول بعضهما البعض في شكل حلزوني مزدوج، وكل سلسلة مكونة من وحدات تسمى النيوكليوتيدات.',
    'rna': 'الحمض النووي الريبوزي (RNA) هو جزيء أحادي السلسلة يلعب دوراً في نقل المعلومات الوراثية من DNA إلى البروتينات. يوجد منه أنواع عديدة مثل الRNA المرسال (mRNA) الذي ينقل الشفرة الوراثية، الRNA الناقل (tRNA) الذي يحمل الأحماض الأمينية، والRNA الريبوسومي (rRNA) الذي يشكل جزءاً من الريبوسومات.',
    'krebs': 'دورة كريبس (دورة حمض الستريك) هي سلسلة من التفاعلات الكيميائية الحيوية التي تحدث في الميتوكوندريا لأكسدة الأسيتيل كوانزيم أ وإنتاج NADH وFADH2 وATP. تعتبر مرحلة رئيسية في التنفس الخلوي وتتكون من 8 خطوات متتالية.',
    'peptide': 'الروابط الببتيدية هي روابط كيميائية تتكون بين مجموعة الكربوكسيل لحمض أميني ومجموعة الأمين لحمض أميني آخر، مع فقدان جزيء ماء. هذه الروابط هي الأساس في تكوين البروتينات وتنشأ أثناء عملية ترجمة البروتين في الريبوسومات.',
    'metabolism': 'التمثيل الغذائي (الأيض) هو مجموعة التفاعلات الكيميائية التي تحدث في الخلايا الحية للحفاظ على الحياة. يشمل عمليات الهدم (الكاتابوليزم) التي تفكك الجزيئات المعقدة لإنتاج الطاقة، وعمليات البناء (الأنابوليزم) التي تستخدم الطاقة لبناء جزيئات معقدة.',
    'glycoprotein': 'البروتينات السكرية هي جزيئات تتكون من بروتين مرتبط بواحد أو أكثر من السكريات. تلعب دوراً مهماً في التعرف الخلوي والاتصال بين الخلايا وتوجد بكثرة على سطح الخلية. كما تلعب دوراً في جهاز المناعة وفي تحديد فصائل الدم.',
    'cellular_respiration': 'التنفس الخلوي هو مجموعة من التفاعلات الحيوية التي تحول الجلوكوز والأكسجين إلى ثاني أكسيد الكربون وماء، مع إنتاج ATP كمصدر للطاقة. يتضمن ثلاث مراحل رئيسية: تحلل الجلوكوز، دورة كريبس، وسلسلة نقل الإلكترون.',
    'photosynthesis': 'البناء الضوئي هو عملية تحويل الطاقة الضوئية إلى طاقة كيميائية في النباتات والطحالب والبكتيريا الزرقاء. خلال هذه العملية، يتم استخدام ثاني أكسيد الكربون والماء لإنتاج الجلوكوز والأكسجين باستخدام الطاقة الضوئية من الشمس.',
    'amino_acid': 'الأحماض الأمينية هي اللبنات الأساسية للبروتينات. تتكون من مجموعة أمين (-NH2)، مجموعة كربوكسيل (-COOH)، ذرة هيدروجين، ومجموعة جانبية (R) تختلف من حمض أميني لآخر. هناك 20 حمضاً أمينياً أساسياً تدخل في تركيب البروتينات. تصنف حسب خصائص سلسلتها الجانبية إلى قطبية، غير قطبية، حمضية، وقاعدية.'
}

# وظيفة تحميل قاعدة المعرفة المخزنة محلياً (إن وجدت)
def load_knowledge_base():
    """تحميل قاعدة المعرفة المحلية من ملف JSON"""
    try:
        if os.path.exists(KNOWLEDGE_DB_PATH):
            with open(KNOWLEDGE_DB_PATH, 'r', encoding='utf-8') as file:
                return json.load(file)
        return {'responses': BASE_RESPONSES, 'last_updated': datetime.now().isoformat()}
    except Exception as e:
        print(f"خطأ عند تحميل قاعدة المعرفة المحلية: {str(e)}")
        return {'responses': BASE_RESPONSES, 'last_updated': datetime.now().isoformat()}

# وظيفة حفظ قاعدة المعرفة محلياً
def save_knowledge_base(knowledge_base):
    """حفظ قاعدة المعرفة المحلية إلى ملف JSON"""
    try:
        knowledge_base['last_updated'] = datetime.now().isoformat()
        with open(KNOWLEDGE_DB_PATH, 'w', encoding='utf-8') as file:
            json.dump(knowledge_base, file, ensure_ascii=False, indent=4)
        return True
    except Exception as e:
        print(f"خطأ عند حفظ قاعدة المعرفة المحلية: {str(e)}")
        return False

# وظيفة إضافة استجابة جديدة إلى قاعدة المعرفة
def add_response_to_knowledge_base(key, response):
    """إضافة استجابة جديدة إلى قاعدة المعرفة المحلية"""
    knowledge_base = load_knowledge_base()
    knowledge_base['responses'][key] = response
    return save_knowledge_base(knowledge_base)

# وظيفة تحليل السؤال وتحديد الموضوع الرئيسي
def analyze_question(question):
    """تحليل السؤال لتحديد الموضوع الرئيسي"""
    question = question.lower()
    
    # البحث عن أنماط معروفة
    for pattern, topic in COMMON_PATTERNS.items():
        if re.search(pattern, question, re.IGNORECASE):
            return topic
    
    # البحث عن كلمات مفتاحية مباشرة
    for keyword in BASE_RESPONSES.keys():
        if keyword in question:
            return keyword
    
    # إذا لم يتم العثور على مطابقة
    return None

# الوظيفة الرئيسية للحصول على استجابة محلية
def get_local_response(question):
    """الحصول على استجابة محلية لسؤال متعلق بالكيمياء الحيوية"""
    
    # تحميل قاعدة المعرفة
    knowledge_base = load_knowledge_base()
    responses = knowledge_base['responses']
    
    # تحليل السؤال
    topic = analyze_question(question)
    
    # إذا تم تحديد موضوع
    if topic and topic in responses:
        # إضافة تنويع للإجابة لتبدو أكثر طبيعية
        prefix = random.choice(GENERAL_RESPONSES)
        return f"{prefix}{responses[topic]}"
    
    # إجابة عامة إذا لم يتم العثور على موضوع محدد
    return "أعتذر، لا يمكنني تقديم إجابة محددة لهذا السؤال في الوضع المحلي. يرجى طرح سؤال آخر متعلق بالمفاهيم الأساسية للكيمياء الحيوية مثل الإنزيمات، البروتينات، الأحماض النووية، أو عمليات التمثيل الغذائي."

# تهيئة قاعدة المعرفة عند تحميل الوحدة
if not os.path.exists(KNOWLEDGE_DB_PATH):
    initial_knowledge = {'responses': BASE_RESPONSES, 'last_updated': datetime.now().isoformat()}
    save_knowledge_base(initial_knowledge)

# استخدام نموذج الاختبار
if __name__ == "__main__":
    # اختبار بعض الأسئلة
    test_questions = [
        "ما هي الإنزيمات؟",
        "كيف تعمل دورة كريبس؟",
        "ما الفرق بين DNA و RNA؟",
        "شرح عملية البناء الضوئي",
        "ما هي الأحماض الأمينية الأساسية؟",
        "سؤال غير متعلق بالكيمياء الحيوية"
    ]
    
    for q in test_questions:
        print(f"السؤال: {q}")
        print(f"الجواب: {get_local_response(q)}")
        print("-" * 50)
